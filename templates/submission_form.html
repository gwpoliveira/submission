{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <!-- Título H1 com destaque e subtítulo estilizado -->
    <div class="text-center mb-4">
        <h1 class="display-3 text-secondary">Submeta Seu Trabalho</h1>
        <p class="text-muted">Preencha as informações abaixo para enviar sua submissão.</p>
    </div>

    <!-- Formulário de submissão -->
    <form method="post" enctype="multipart/form-data" class="shadow-lg p-4 rounded bg-light">
        {% csrf_token %}

        <!-- Seção de Informações do Usuário -->
        <div class="mb-4">
            <h4 class="text-secondary">Informações Pessoais</h4>
            <hr class="mt-0 mb-3">
            {{ profile_form.as_p }}
        </div>

        <!-- Seção de Submissão -->
        <div class="mb-4">
            <h4 class="text-secondary">Detalhes da Submissão</h4>
            <hr class="mt-0 mb-3">
            {{ submission_form.as_p }}
        </div>

        <!-- Exibir erros de validação do arquivo, se houver -->
        {% if submission_form.arquivo.errors %}
            <div class="alert alert-danger">
                {{ submission_form.arquivo.errors }}
            </div>
        {% endif %}

        <!-- Seção de Componentes -->
        <div class="mb-4">
            <h4 class="text-secondary">Componentes do Trabalho</h4>
            <hr class="mt-0 mb-3">
            {{ component_formset.management_form }}

            <div id="component-forms">
                {% for form in component_formset %}
                    <div class="component-form mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                {{ form.nome.label_tag }} {{ form.nome }}
                            </div>
                            <div class="col-md-4">
                                {{ form.cpf.label_tag }} {{ form.cpf }}
                            </div>
                            <div class="col-md-4">
                                {{ form.email.label_tag }} {{ form.email }}
                            </div>
                        </div>
                        <button type="button" class="btn btn-danger mt-2 remove-form">Remover Componente</button>
                    </div>
                {% endfor %}
            </div>

            <button type="button" id="add-component" class="btn btn-success">Adicionar Componente</button>
        </div>

        <!-- Botão de Envio -->
        <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg px-5">
                <i class="bi bi-file-earmark-arrow-up-fill"></i> Enviar Submissão
            </button>
        </div>
    </form>
</div>

<script>
    // Função para remover um componente
    document.querySelectorAll('.remove-form').forEach(button => {
        button.addEventListener('click', function() {
            this.closest('.component-form').remove();
        });
    });

    // Função para adicionar um novo componente
    document.getElementById('add-component').addEventListener('click', function () {
        const formContainer = document.getElementById('component-forms');
        const totalForms = document.querySelectorAll('.component-form').length;

        // Duplicando o último form para adicionar outro componente
        const newForm = document.querySelector('.component-form').cloneNode(true);
        newForm.querySelectorAll('input').forEach(input => input.value = ''); // Limpa os inputs

        // Atualizar os índices dos novos formulários
        newForm.innerHTML = newForm.innerHTML.replace(/form-(\d)-/g, `form-${totalForms}-`);
        formContainer.appendChild(newForm);

        // Reanexar o evento de remover ao novo botão
        newForm.querySelector('.remove-form').addEventListener('click', function() {
            newForm.remove();
        });

        // Atualizar o total de formulários gerenciados no formset
        const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');
        totalFormsInput.setAttribute('value', totalForms + 1);
    });
</script>

{% endblock %}
